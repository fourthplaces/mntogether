[package]
name = "server"
version.workspace = true
edition.workspace = true

[lib]
name = "server_core"
path = "src/lib.rs"

[[bin]]
name = "generate_embeddings"
path = "src/bin/generate_embeddings.rs"

[[bin]]
name = "migrate_cli"
path = "src/bin/migrate_cli.rs"

[[bin]]
name = "run_migrations"
path = "src/bin/run_migrations.rs"

[[bin]]
name = "server"
path = "src/bin/server.rs"

[dependencies]
# Async runtime
tokio = { workspace = true }
async-trait = "0.1"
futures = "0.3"
tokio-stream = { version = "0.1", features = ["sync"] }

# Real-time messaging
async-nats = "0.38"
bytes = "1.7"

# Error handling
anyhow = { workspace = true }
thiserror = { workspace = true }

# Serialization
serde = { workspace = true }
serde_json = { workspace = true }

# IDs and timestamps
uuid = { workspace = true }
chrono = { workspace = true }

# Logging
tracing = { workspace = true }
tracing-subscriber = { workspace = true }

# Durable execution with Restate
restate-sdk = "0.4.0"

# Authentication
twilio = { path = "../twilio-rs" }
jsonwebtoken = "9"

# Hashing
md5 = "0.7"

# Database
sqlx = { workspace = true, features = ["migrate"] }
dataloader = "0.18"
pgvector = { version = "0.4", features = ["sqlx", "serde"] }

# AI / LLM - via extraction library
extraction = { path = "../extraction", features = ["postgres", "openai", "firecrawl"] }
ai-client = { path = "../ai-client" }
apify-client = { path = "../apify-client" }

# LLM framework (rig.rs)
rig-core = "0.9"
schemars = "0.8"

# HTTP client (for Expo + Restate)
reqwest = { workspace = true }
urlencoding = "2.1"
url = "2.5"
hyper = { version = "1", features = ["full"] }

# Web scraping (search via extraction library's TavilyWebSearcher)
scraper = "0.21"        # HTML parsing with CSS selectors
htmd = "0.1"            # HTML to Markdown conversion

# RFC 5545 recurrence rules (calendar events)
rrule = "0.14"

# Environment
dotenvy = { workspace = true }

# Content hashing (duplicate detection)
sha2 = { workspace = true }

# Markdown rendering
pulldown-cmark = "0.9"
hex = "0.4"

# Base64 encoding (for cursor pagination)
base64 = "0.22"

# Builder pattern
typed-builder = "0.20"

# PII Detection and Redaction
regex = "1.10"
lazy_static = "1.4"
rust_decimal = { version = "1.40.0", features = ["db-postgres", "serde", "std"] }

# CLI (for migrate_cli)
clap = { version = "4.5", features = ["derive"] }

# Restate HTTP server
http = "1"

# SSE endpoint
axum = "0.8"

[dev-dependencies]
# Testing
tokio-test = "0.4"
test-context = "0.3"
testcontainers = { workspace = true }
testcontainers-modules = { version = "0.11", features = ["postgres", "redis"] }
indexmap = "2.0"
